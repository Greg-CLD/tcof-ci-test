REPLIT AGENT PROMPT – Admin Fix + Auto-Canonical Sync
less
Copy
Edit
We still have mismatches between Admin pages, routes, and canonical success factors.  
Please implement the following fixes:

────────────────────────────────────────────────────────
1️⃣  ROUTE & NAVIGATION

• Ensure the Admin Factor Editor is accessible at **/make-a-plan/admin/factors**  
  – Add a visible nav link labelled “Admin – Factors” in the authenticated header (SiteHeader.tsx).  
• When an unauthorised user visits that route, show “Access denied”.  
• Treat email check **case-insensitively** so both greg@confluity.co.uk and Greg@Confluity.co.uk are valid.

────────────────────────────────────────────────────────
2️⃣  ALWAYS SHOW “Update to Canonical Factors” BUTTON

• Inside AdminFactorEditor.tsx make sure the button with label  
  **“Update to Canonical Factors”** is always rendered for authorised admin, never hidden.  
• Place it at the top of the page (right-aligned) for visibility.

────────────────────────────────────────────────────────
3️⃣  AUTO-SYNC CANONICAL FACTORS ⏩  (NO more manual clicks)

• Create **server-side hook** `ensureCanonicalFactors()` that runs on server start:  
  – Fetch current factors from DB.  
  – If count ≠ 12 **or** any title doesn’t match the canonical list (below),  
    replace the DB entry with the canonical 12 and log `console.info('Canonical factors refreshed')`.  

1.1 Ask Why
1.2 Get a Masterbuilder
1.3 Get Your People on the Bus
1.4 Make Friends and Keep them Friendly

2.1 Recognise that your project is not unique
2.2 Look for Tried & Tested Options

3.1 Think Big, Start Small
3.2 Learn by Experimenting
3.3 Keep on top of risks

4.1 Adjust for optimism
4.2 Measure What Matters, Be Ready to Step Away
4.3 Be Ready to Adapt

sql
Copy
Edit

• Factor IDs may be `sf-1 … sf-12` or the numeric prefixes above – use whatever is already referenced in code but keep them stable.

────────────────────────────────────────────────────────
4️⃣  ADMIN UI CLEAN-UP

• In the “Core Heuristics (Read-only)” table show **ID + Title** (no blank title cells).  
• Remove duplicate rows: only 12 rows should appear.  
• Under each factor allow the admin to view/edit tasks by stage, but titles must be read-only.

────────────────────────────────────────────────────────
5️⃣  BLOCK 2 FIXES

• Production “white screen” is caused by Block2Connect failing to load tasks → add try/catch and console log.  
• Remove the entire **“Import Tasks from Database”** section (not part of the spec).  
• “No personal heuristics found” message should appear only if `personalHeuristics.length === 0`.

────────────────────────────────────────────────────────
6️⃣  TESTS

• Add `tests/canonicalSync.test.ts` – start app with mock DB containing 5 factors, run `ensureCanonicalFactors()`, assert DB now has 12 correct titles.  
• Add `tests/adminRoute.test.tsx` – mount SiteHeader, assert link “Admin – Factors” exists when `currentUser.email` matches greg@… (case-insensitive).

────────────────────────────────────────────────────────
DELIVERABLES
• Updated routes in App.tsx  
• Updated SiteHeader.tsx  
• New server util `ensureCanonicalFactors.ts` (called in server bootstrap)  
• AdminFactorEditor.tsx layout update  
• Block2Connect.tsx cleaned / error-handled  
• New tests

After deployment:
• Visiting /make-a-plan/admin/factors as greg@confluity.co.uk shows the editor with 12 rows and the visible “Update to Canonical Factors” button.  
• Step 1 always shows the 12 canonical titles.  
• Block 2 no longer crashes and no longer shows “Import Tasks from Database”.

End of prompt
