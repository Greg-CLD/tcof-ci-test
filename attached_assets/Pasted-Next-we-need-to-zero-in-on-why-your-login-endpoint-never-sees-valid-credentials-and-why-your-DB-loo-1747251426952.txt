Next, we need to zero in on why your login endpoint never sees valid credentials—and why your DB lookup is choking on a syntax error. Here are the specific checks I’d ask the Assistant/Agent to run, in order, to diagnose and fix:

Inspect the incoming request

Instrument your login handler with

js
Copy
Edit
console.log('→ Headers:', req.headers);
console.log('→ Body:', req.body);
and retry the POST. Are the email/password fields arriving at all?

Verify your test payload & headers

In your test script or cURL, ensure you’re sending JSON with the right field names and Content-Type: application/json.

Example:

bash
Copy
Edit
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"greg@confluity.co.uk","password":"<your-password>"}'
Confirm the server logs match what you intended to send.

Confirm body-parser / JSON middleware

Make sure app.use(express.json()) (or your equivalent) runs before you mount the auth routes.

If it’s missing or in the wrong order, req.body will be empty and you’ll get “Missing credentials.”

Fix the DB lookup syntax

Your stack trace shows a syntax error at end of input in checkUser().

Log out the exact SQL query string you’re sending to Postgres.

Ensure you have a complete SELECT * FROM users WHERE email = $1 (and that you supply the parameter).

Validate the user exists & password compare

After you fetch the user row, log out user.passwordHash (never in production—just for debugging).

Run bcrypt.compare(req.body.password, user.passwordHash) and log both inputs and the boolean result.

Re-run your auth-flow test

With those logs in place, re-execute node test-auth-flow.js.

Paste the new console output here so we can see exactly where it’s breaking.

Once we can see

exactly what the server receives,

the exact SQL sent to Postgres,

and the bcrypt comparison result—

we’ll know if it’s (a) a missing body/headers problem, (b) a middleware ordering issue, or (c) a bad SQL/password-compare bug. Then we can fix it and confirm a successful login.